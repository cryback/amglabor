<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Labor % Calculator</title>
  <meta name="description" content="AMG Labor Percentage Calculator by park location" />
  <link rel="icon" href="logo.png" />
  <style>
    :root {
      --bg: #ffffff;
      --card: #fafafa;
      --border: #eaeaea;
      --text: #111;
      --muted: #666;
      --accent: #0a7cff;
      --good: #00a884;
      --warn: #f59e0b;
      --bad:  #ef4444;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text); background: var(--bg);
    }
    header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 18px;
    }
    header img { width: 44px; height: 44px; border-radius: 10px; }
    h1 { font-size: 1.4rem; margin: 0; }
    .wrap { max-width: 760px; margin: 0 auto; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 16px;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .control label { display: block; font-weight: 600; margin-bottom: 6px; }
    select, input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      background: #fff;
    }
    output, .stat {
      display: block;
      font-weight: 700;
      font-size: 1.25rem;
      padding: 10px 12px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: #fff;
    }
    .hint { color: var(--muted); font-size: .92rem; }
    .pct { font-variant-numeric: tabular-nums; }
    .money, .hours { font-variant-numeric: tabular-nums; }
    .gauge {
      height: 12px; border-radius: 999px; background: #eee; overflow: hidden; margin-top: 8px;
    }
    .gauge > span { display: block; height: 100%; background: var(--good); width: 0%; transition: width .2s ease; }
    .gauge.bad > span { background: var(--bad); }
    .gauge.warn > span { background: var(--warn); }
    #daily-totals { margin-top: 2px; }
    #daily-totals h2 { margin: 0 0 6px 0; font-size: 1.1rem; }
    #daily-totals-note { color: var(--muted); font-size: .92rem; margin-bottom: 6px; }
    #daily-totals-list {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      line-height: 1.55;
      white-space: pre-wrap;
      margin: 0;
    }
    footer { margin-top: 20px; color: var(--muted); font-size: .9rem; }
    @media (max-width: 720px) {
      .row, .row-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="logo.png" alt="AMG Logo" />
      <div>
        <h1>Labor % Calculator</h1>
        <div class="hint">Calculate labor percentage by park location</div>
      </div>
    </header>

    <!-- Park selection -->
    <section class="card" aria-labelledby="park-title">
      <div class="row">
        <div class="control">
          <label id="park-title" for="parkSelect">Select Park Location</label>
          <select id="parkSelect" aria-describedby="park-help">
            <option value="">-- Choose a Park --</option>
            <!-- options injected from rates.json -->
          </select>
          <div id="park-help" class="hint"></div>
        </div>

        <div class="control">
          <label for="hourlyRateValue">Hourly Rate</label>
          <output id="hourlyRateValue" class="money" aria-live="polite">$0.00</output>
          <div class="hint">Pulled from <code>rates.json</code></div>
        </div>
      </div>
    </section>

    <!-- Inputs -->
    <section class="card">
      <div class="row">
        <div class="control">
          <label for="laborHours">Labor Hours Total</label>
          <input id="laborHours" inputmode="decimal" type="number" min="0" step="0.01" placeholder="e.g., 125.5" />
        </div>
        <div class="control">
          <label for="revenue">Revenue ($)</label>
          <input id="revenue" inputmode="decimal" type="number" min="0" step="0.01" placeholder="e.g., 5200" />
        </div>
      </div>
    </section>

    <!-- Outputs -->
    <section class="card">
      <div class="row">
        <div class="control">
          <label for="laborPctValue">Labor Percentage</label>
          <output id="laborPctValue" class="pct">--%</output>
          <div id="pctGauge" class="gauge" aria-hidden="true"><span style="width:0%"></span></div>
          <div class="hint">Target ≤ 18%</div>
        </div>
        <div class="control">
          <label for="calcLaborCost">Calculated Labor Cost</label>
          <output id="calcLaborCost" class="money">$0.00</output>
        </div>
      </div>
    </section>

    <!-- Daily Totals (per-park) -->
    <section id="daily-totals" class="card" aria-labelledby="daily-totals-title">
      <h2 id="daily-totals-title">Daily Totals</h2>
      <div id="daily-totals-note" class="hint"></div>
      <pre id="daily-totals-list" aria-label="Daily totals (monospaced)"></pre>
    </section>

    <footer>
      <span class="hint">This calculator reads <code>rates.json</code> and <code>daily_totals.json</code> from GitHub Pages (absolute URLs), with a local fallback for development.</span>
    </footer>
  </div>

  <script>
    (function () {
      // --- Absolute origin for hosted JSON (TestFlight-safe) ---
      const ORIGIN = 'https://cryback.github.io/amglabor';

      // Helper: try absolute URL first (GitHub Pages), then fall back to relative for local/dev use.
      async function fetchJSON(name) {
        try {
          const abs = await fetch(`${ORIGIN}/${name}`, { cache: 'no-store' });
          if (!abs.ok) throw new Error(`${name} HTTP ${abs.status}`);
          return await abs.json();
        } catch (e) {
          // Fallback if offline or running from local file:// or a dev server with local copies
          const rel = await fetch(name, { cache: 'no-store' });
          if (!rel.ok) throw new Error(`${name} (relative) HTTP ${rel.status}`);
          return await rel.json();
        }
      }

      // Elements
      const parkSelect = document.getElementById('parkSelect');
      const parkHelp   = document.getElementById('park-help');
      const hourlyOut  = document.getElementById('hourlyRateValue');
      const hoursIn    = document.getElementById('laborHours');
      const revIn      = document.getElementById('revenue');
      const pctOut     = document.getElementById('laborPctValue');
      const costOut    = document.getElementById('calcLaborCost');
      const gauge      = document.getElementById('pctGauge').firstElementChild;
      const gaugeWrap  = document.getElementById('pctGauge');

      const dailyNote  = document.getElementById('daily-totals-note');
      const dailyList  = document.getElementById('daily-totals-list');

      // State
      let rates = {};              // { ParkName: number }
      let dailyTotalsByPark = {};  // { ParkName: { weekOf, days[], totalPct } }

      // Utils
      const fmtMoney = (n) =>
        new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(Number(n || 0));

      const fmtPct = (n) => (n == null || isNaN(n)) ? '--%' : (Number(n).toFixed(2) + '%');

      const toNumber = (el) => {
        const v = Number((el.value || '').toString().replace(/,/g, ''));
        return isFinite(v) ? v : 0;
      };

      function classifyGauge(percent) {
        // ≤18 good, 18–22 warn, >22 bad
        const wrap = gaugeWrap;
        wrap.classList.remove('good','warn','bad');
        if (!isFinite(percent)) return;
        if (percent <= 18) wrap.classList.add('good');
        else if (percent <= 22) wrap.classList.add('warn');
        else wrap.classList.add('bad');
      }

      function updateCalc() {
        const park = parkSelect.value || '';
        const rate = Number(rates[park] || 0);
        const hours = toNumber(hoursIn);
        const rev = toNumber(revIn);

        hourlyOut.textContent = fmtMoney(rate);

        const cost = rate * hours;
        costOut.textContent = fmtMoney(cost);

        let pct = NaN;
        if (rev > 0) pct = (cost / rev) * 100;

        pctOut.textContent = isFinite(pct) ? fmtPct(pct) : '--%';

        const w = isFinite(pct) ? Math.max(0, Math.min(100, pct)) : 0;
        gauge.style.width = w + '%';
        classifyGauge(pct);
      }

      function renderDailyTotalsFor(parkName) {
        const EMPTY =
          'Mon - --/-- - 0.00 - $0.00 - --%\n' +
          'Tue - --/-- - 0.00 - $0.00 - --%\n' +
          'Wed - --/-- - 0.00 - $0.00 - --%\n' +
          'Thu - --/-- - 0.00 - $0.00 - --%\n' +
          'Fri - --/-- - 0.00 - $0.00 - --%\n' +
          'Sat - --/-- - 0.00 - $0.00 - --%\n' +
          'Sun - --/-- - 0.00 - $0.00 - --%\n\n' +
          'Total - 0.00 - $0.00 - --%';

        if (!parkName) {
          dailyList.textContent = EMPTY;
          dailyNote.textContent = 'Select a park.';
          return;
        }
        const pack = dailyTotalsByPark[parkName];
        if (!pack || !Array.isArray(pack.days)) {
          dailyList.textContent = EMPTY;
          dailyNote.textContent = `No daily totals found for ${parkName}.`;
          return;
        }
        const lines = pack.days.map(d =>
          `${d.dow} - ${d.date} - ${Number(d.hours ?? 0).toFixed(2)} - ${fmtMoney(d.cost)} - ${fmtPct(d.pct)}`
        );

        const totalHours = pack.days.reduce((s, d) => s + Number(d.hours || 0), 0);
        const totalCost  = pack.days.reduce((s, d) => s + Number(d.cost  || 0), 0);
        lines.push('');
        lines.push(`Total - ${totalHours.toFixed(2)} - ${fmtMoney(totalCost)} - ${fmtPct(pack.totalPct)}`);

        dailyList.textContent = lines.join('\n');
        dailyNote.textContent = `Week of ${pack.weekOf} — ${parkName}`;
      }

      function onParkChange() {
        updateCalc();
        renderDailyTotalsFor(parkSelect.value || '');
      }

      // Loaders
      async function loadRates() {
        const data = await fetchJSON('rates.json');

        // Accept either object map {Park: rate} or array [{name, rate}]
        if (Array.isArray(data)) {
          data.forEach(row => {
            if (row && row.name) rates[row.name] = Number(row.rate || row.value || 0);
          });
        } else {
          rates = Object.fromEntries(Object.entries(data).map(([k, v]) => [k, Number(v || 0)]));
        }

        // Build dropdown from rates keys
        const parks = Object.keys(rates);
        parks.sort((a,b) => a.localeCompare(b));
        for (const name of parks) {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          parkSelect.appendChild(opt);
        }
        parkHelp.textContent = parks.length ? `${parks.length} parks loaded from rates.json` : 'No parks found in rates.json';

        // Auto-select first park so Daily Totals render immediately
        if (!parkSelect.value && parks.length) {
          parkSelect.value = parks[0];
        }

        // Diagnostics
        console.log('rates.json loaded parks:', parks);
      }

      async function loadDailyTotals() {
        try {
          dailyTotalsByPark = await fetchJSON('daily_totals.json');

          // Diagnostics: show which parks were found in daily_totals.json
          console.log('daily_totals.json loaded parks:', Object.keys(dailyTotalsByPark));
        } catch (err) {
          dailyTotalsByPark = {};
          dailyNote.textContent = 'Daily totals unavailable (could not load daily_totals.json).';
          dailyList.textContent =
            'Mon - --/-- - 0.00 - $0.00 - --%\nTue - --/-- - 0.00 - $0.00 - --%\nWed - --/-- - 0.00 - $0.00 - --%\nThu - --/-- - 0.00 - $0.00 - --%\nFri - --/-- - 0.00 - $0.00 - --%\nSat - --/-- - 0.00 - $0.00 - --%\nSun - --/-- - 0.00 - $0.00 - --%\n\nTotal - 0.00 - $0.00 - --%';
          console.warn(err);
        }
      }

      // Wire events
      parkSelect.addEventListener('change', onParkChange);
      hoursIn.addEventListener('input', updateCalc);
      revIn.addEventListener('input', updateCalc);

      // Init
      (async function init() {
        try {
          await loadRates();
          await loadDailyTotals();
        } catch (e) {
          console.warn(e);
        } finally {
          // Initial render (will use the auto-selected first park, if any)
          onParkChange();
        }
      })();
    })();
  </script>
</body>
</html>
