<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Labor % Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2933 0, #020617 55%);
      color: #e5e7eb;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    header img {
      height: 56px;
      width: auto;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      padding: 0.3rem 0.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0.15rem 0 0;
      color: #9ca3af;
      font-size: 0.9rem;
    }

    .card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 1rem;
      padding: 1.2rem 1.4rem 1.4rem;
      margin-bottom: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow:
        0 18px 30px rgba(15, 23, 42, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      font-size: 1.1rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem 1.25rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: #9ca3af;
    }

    select,
    input[type="number"] {
      width: 100%;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.9);
      padding: 0.45rem 0.6rem;
      color: #e5e7eb;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      background: rgba(15, 23, 42, 1);
    }

    .muted {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }

    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .kpi {
      flex: 1 1 130px;
      min-width: 130px;
      padding: 0.6rem 0.75rem;
      border-radius: 0.7rem;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .kpi-label {
      font-size: 0.75rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .kpi-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .kpi-highlight {
      font-size: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      margin-top: 0.25rem;
      border: 1px solid transparent;
    }

    .status-neutral {
      background: rgba(75, 85, 99, 0.25);
      border-color: rgba(75, 85, 99, 0.5);
      color: #e5e7eb;
    }

    .status-excellent {
      background: rgba(22, 163, 74, 0.25);
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
    }

    .status-good {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.7);
      color: #bfdbfe;
    }

    .status-warn {
      background: rgba(234, 179, 8, 0.2);
      border-color: rgba(234, 179, 8, 0.7);
      color: #facc15;
    }

    .status-high {
      background: rgba(248, 113, 113, 0.16);
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .status-critical {
      background: rgba(127, 29, 29, 0.7);
      border-color: rgba(220, 38, 38, 0.85);
      color: #fecaca;
    }

    .daily-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .daily-header small {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .totals-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 0.8rem;
      overflow: hidden;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 0.85rem;
    }

    .totals-table thead {
      background: radial-gradient(circle at top left, #0f172a, #020617);
    }

    .totals-table th,
    .totals-table td {
      padding: 0.45rem 0.55rem;
      text-align: right;
    }

    .totals-table th:first-child,
    .totals-table td:first-child {
      text-align: left;
    }

    .totals-table tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.95);
    }

    .totals-table tbody tr:nth-child(even) {
      background: rgba(17, 24, 39, 0.95);
    }

    .totals-table tbody tr:hover {
      background: rgba(30, 64, 175, 0.45);
    }

    .pill {
      display: inline-flex;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.75rem;
    }

    .pill-good {
      border-color: rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
    }

    .pill-bad {
      border-color: rgba(239, 68, 68, 0.9);
      color: #fecaca;
    }

    .pill-na {
      border-color: rgba(75, 85, 99, 0.9);
      color: #9ca3af;
    }

    .info-line {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }

    @media (max-width: 640px) {
      body {
        padding: 0.9rem;
      }

      .card {
        padding: 0.9rem 1rem 1.1rem;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      header img {
        height: 48px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <img src="logo.png" alt="AMG Logo" />
      <div>
        <h1>Labor % Calculator</h1>
        <p>Calculate labor percentage by park location</p>
      </div>
    </header>

    <section class="card" id="calculator">
      <h2>Calculator</h2>
      <div class="grid">
        <div>
          <label for="parkSelect">Select Park Location</label>
          <select id="parkSelect">
            <option value="" disabled selected>-- Choose a Park --</option>
          </select>
          <div class="muted">Pulled from <code>rates.json</code></div>
        </div>

        <div>
          <label>Hourly Rate</label>
          <div class="kpi">
            <span class="kpi-label">Hourly Rate</span>
            <span id="hourlyRate" class="kpi-value">$0.00</span>
          </div>
        </div>

        <div>
          <label for="laborHours">Labor Hours Total</label>
          <input
            id="laborHours"
            type="number"
            inputmode="decimal"
            step="0.01"
            min="0"
            placeholder="e.g. 145.5"
          />
        </div>

        <div>
          <label for="revenue">Revenue ($)</label>
          <input
            id="revenue"
            type="number"
            inputmode="decimal"
            step="0.01"
            min="0"
            placeholder="e.g. 25000"
          />
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <span class="kpi-label">Labor Percentage</span>
          <span id="laborPercentage" class="kpi-value kpi-highlight">--%</span>
          <span id="laborStatus" class="status-pill status-neutral">Waiting for inputs…</span>
        </div>
        <div class="kpi">
          <span class="kpi-label">Target</span>
          <span class="kpi-value">
            ≤ <span id="targetDisplay">18</span>%
          </span>
          <div class="muted">Configurable via <code>rates.json</code> (<code>target_percentage</code>)</div>
        </div>
        <div class="kpi">
          <span class="kpi-label">Calculated Labor Cost</span>
          <span id="laborCost" class="kpi-value">$0.00</span>
        </div>
      </div>
    </section>

    <section class="card" id="dailyTotals">
      <div class="daily-header">
        <h2>Daily Totals</h2>
        <small id="dailyTotalsMeta"></small>
      </div>
      <p class="muted" id="dailyTotalsMessage">
        Choose a park above to see recent daily totals pulled from <code>daily_totals.json</code>.
      </p>
      <div id="dailyTotalsContent"></div>
      <p class="info-line">
        This calculator reads <code>rates.json</code> and <code>daily_totals.json</code> from GitHub Pages with a local
        fallback for development.
      </p>
    </section>
  </main>

<script>
  // ---------- CONFIG & FALLBACKS ----------
  const DEFAULT_RATES = {
    "Appleton": 17.32,
    "Austell": 16.07,
    "Gastonia": 16.99,
    "Huntsville": 14.86,
    "Lawrenceville": 13.55,
    "Lombard": 18.87,
    "Nashville": 17.10,
    "Pueblo": 18.27,
    "San Jose": 21.34,
    "York": 18.22
  };

  let hourlyRates = {};
  let targetPercent = 18;
  let dailyTotals = null;
  let manualDailyParkSelection = false;

  // ---------- HELPERS ----------
  function formatCurrency(value) {
    const num = Number(value);
    if (!isFinite(num)) return "$0.00";
    return num.toLocaleString("en-US", {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function formatPercent(value) {
    const num = Number(value);
    if (!isFinite(num)) return "--%";
    return num.toFixed(2) + "%";
  }

  function setStatus(percent) {
    const statusEl = document.getElementById("statusText");
    const card = document.getElementById("resultsCard");

    if (!isFinite(percent)) {
      statusEl.textContent = "Waiting for inputs…";
      card.className = "results-card neutral";
      return;
    }

    let msg = "";
    let cls = "";

    if (percent <= 15) {
      msg = "Excellent – Below 15%";
      cls = "results-card excellent";
    } else if (percent <= targetPercent) {
      msg = "On Target – Meeting goal";
      cls = "results-card on-target";
    } else if (percent <= 22) {
      msg = "Slightly Above Target";
      cls = "results-card slightly-high";
    } else if (percent <= 28) {
      msg = "High – Needs Attention";
      cls = "results-card high";
    } else {
      msg = "Critical – Significantly Over";
      cls = "results-card critical";
    }

    statusEl.textContent = msg;
    card.className = cls;
  }

  // ---------- RATES / PARK SELECT ----------
  async function loadRates() {
    try {
      const response = await fetch("rates.json", { cache: "no-cache" });
      if (!response.ok) throw new Error("HTTP " + response.status);
      const data = await response.json();
      parseRatesData(data);
    } catch (err) {
      console.warn("Using fallback hourly rates:", err);
      hourlyRates = { ...DEFAULT_RATES };
      targetPercent = 18;
    } finally {
      populateParkSelect();
      updateTargetDisplay();
      recalcLabor();
    }
  }

  function parseRatesData(data) {
    // Get target percentage if present
    if (typeof data.target_percentage === "number") {
      targetPercent = data.target_percentage;
    }

    const parks = {};

    // If there is a "parks" object, support that
    if (data.parks && typeof data.parks === "object") {
      for (const [name, info] of Object.entries(data.parks)) {
        if (typeof info === "number") {
          parks[name] = info;
        } else if (info && typeof info.hourly_rate === "number") {
          parks[name] = info.hourly_rate;
        }
      }
    } else {
      // Otherwise, use top-level numeric keys except target_percentage
      for (const [key, value] of Object.entries(data)) {
        if (key === "target_percentage") continue;
        if (typeof value === "number") {
          parks[key] = value;
        }
      }
    }

    if (Object.keys(parks).length === 0) {
      console.warn("No valid parks found in rates.json, using defaults");
      hourlyRates = { ...DEFAULT_RATES };
    } else {
      hourlyRates = parks;
    }
  }

  function populateParkSelect() {
    const parkSelect = document.getElementById("parkSelect");
    if (!parkSelect) return;

    parkSelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "-- Choose a Park --";
    parkSelect.appendChild(placeholder);

    const parkNames = Object.keys(hourlyRates).sort();
    parkNames.forEach((name) => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      parkSelect.appendChild(opt);
    });
  }

  function updateTargetDisplay() {
    const targetEl = document.getElementById("targetPercentDisplay");
    if (targetEl) {
      targetEl.textContent = targetPercent.toFixed(0) + "%";
    }
  }

  // ---------- LABOR CALCULATION ----------
  function recalcLabor() {
    const parkSelect = document.getElementById("parkSelect");
    const hoursInput = document.getElementById("laborHoursInput");
    const revenueInput = document.getElementById("revenueInput");
    const hourlyRateDisplay = document.getElementById("hourlyRateDisplay");
    const laborPercentDisplay = document.getElementById("laborPercentDisplay");
    const laborCostDisplay = document.getElementById("laborCostDisplay");

    if (!parkSelect || !hoursInput || !revenueInput) return;

    const park = parkSelect.value;
    const rate = hourlyRates[park];

    if (!rate) {
      if (hourlyRateDisplay) hourlyRateDisplay.textContent = "$0.00 / hour";
      if (laborPercentDisplay) laborPercentDisplay.textContent = "--%";
      if (laborCostDisplay) laborCostDisplay.textContent = "$0.00";
      setStatus(NaN);
      return;
    }

    if (hourlyRateDisplay) {
      hourlyRateDisplay.textContent = formatCurrency(rate) + " / hour";
    }

    const hours = parseFloat(hoursInput.value);
    const revenue = parseFloat(revenueInput.value);

    if (!isFinite(hours) || hours <= 0 || !isFinite(revenue) || revenue <= 0) {
      if (laborPercentDisplay) laborPercentDisplay.textContent = "--%";
      if (laborCostDisplay) laborCostDisplay.textContent = "$0.00";
      setStatus(NaN);
      return;
    }

    const laborCost = hours * rate;
    const laborPercent = (laborCost / revenue) * 100;

    if (laborPercentDisplay) {
      laborPercentDisplay.textContent = formatPercent(laborPercent);
    }
    if (laborCostDisplay) {
      laborCostDisplay.textContent = formatCurrency(laborCost);
    }

    setStatus(laborPercent);
  }

  // ---------- DAILY TOTALS ----------
  async function loadDailyTotals() {
    const msgEl = document.getElementById("dailyTotalsMessage");

    try {
      const response = await fetch("daily_totals.json", { cache: "no-cache" });
      if (!response.ok) throw new Error("HTTP " + response.status);

      const data = await response.json();
      // Expecting the structure you pasted:
      // { "weekOf": "...", "parks": { "Appleton": { "days": [...] }, ... } }
      dailyTotals = data;

      const weekOfLabel = document.getElementById("weekOfLabel");
      if (weekOfLabel && data.weekOf) {
        weekOfLabel.textContent = data.weekOf;
      }

      populateDailyParkSelect();
      syncDailyParkWithMain();
      renderDailyTotals();

      if (msgEl) msgEl.textContent = "";
    } catch (err) {
      console.error("Error loading daily_totals.json:", err);
      if (msgEl) msgEl.textContent = "Could not load daily_totals.json.";
    }
  }

  function populateDailyParkSelect() {
    const dailySelect = document.getElementById("dailyParkSelect");
    if (!dailySelect) return;

    dailySelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "-- Match selected park --";
    dailySelect.appendChild(placeholder);

    if (!dailyTotals || !dailyTotals.parks) return;

    const parkNames = Object.keys(dailyTotals.parks).sort();
    parkNames.forEach((name) => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      dailySelect.appendChild(opt);
    });
  }

  function syncDailyParkWithMain() {
    if (manualDailyParkSelection) return; // user already chose something

    const parkSelect = document.getElementById("parkSelect");
    const dailySelect = document.getElementById("dailyParkSelect");
    if (!parkSelect || !dailySelect) return;

    const mainPark = parkSelect.value;
    if (!mainPark) return;

    const option = dailySelect.querySelector(`option[value="${mainPark}"]`);
    if (option) {
      dailySelect.value = mainPark;
    }
  }

  function renderDailyTotals() {
    const dailyTable = document.getElementById("dailyTotalsTable");
    const body = document.getElementById("dailyTotalsBody");
    const msgEl = document.getElementById("dailyTotalsMessage");
    const dailySelect = document.getElementById("dailyParkSelect");

    if (!dailyTable || !body || !dailySelect) return;

    const parkName = dailySelect.value;
    if (!dailyTotals || !dailyTotals.parks || !parkName || !dailyTotals.parks[parkName]) {
      body.innerHTML = "";
      dailyTable.classList.add("hidden");
      if (msgEl) msgEl.textContent = "No data yet. Once we read daily_totals.json, recent days for this park will appear here.";
      return;
    }

    const parkData = dailyTotals.parks[parkName];
    const days = parkData.days || [];

    body.innerHTML = "";

    days.forEach((day) => {
      const tr = document.createElement("tr");

      const pct = (typeof day.pct === "number" && isFinite(day.pct))
        ? day.pct
        : (day.revenue > 0 ? (day.cost / day.revenue) * 100 : 0);

      const cells = [
        day.dow || "",
        day.hours != null ? day.hours.toFixed(2) : "",
        formatCurrency(day.cost || 0),
        formatCurrency(day.revenue || 0),
        formatPercent(pct)
      ];

      cells.forEach((text) => {
        const td = document.createElement("td");
        td.textContent = text;
        tr.appendChild(td);
      });

      body.appendChild(tr);
    });

    dailyTable.classList.remove("hidden");
    if (msgEl) msgEl.textContent = "";
  }

  // ---------- INIT ----------
  document.addEventListener("DOMContentLoaded", () => {
    const parkSelect = document.getElementById("parkSelect");
    const hoursInput = document.getElementById("laborHoursInput");
    const revenueInput = document.getElementById("revenueInput");
    const dailySelect = document.getElementById("dailyParkSelect");

    if (parkSelect) {
      parkSelect.addEventListener("change", () => {
        recalcLabor();
        syncDailyParkWithMain();
        renderDailyTotals();
      });
    }

    if (hoursInput) {
      hoursInput.addEventListener("input", recalcLabor);
    }

    if (revenueInput) {
      revenueInput.addEventListener("input", recalcLabor);
    }

    if (dailySelect) {
      dailySelect.addEventListener("change", () => {
        manualDailyParkSelection = true;
        renderDailyTotals();
      });
    }

    loadRates();
    loadDailyTotals();
  });
</script>

</body>
</html>

