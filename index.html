<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Labor % Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2933 0, #020617 55%);
      color: #e5e7eb;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    header img {
      height: 56px;
      width: auto;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      padding: 0.3rem 0.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.7rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0.15rem 0 0;
      color: #9ca3af;
      font-size: 0.9rem;
    }

    .card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 1rem;
      padding: 1.2rem 1.4rem 1.4rem;
      margin-bottom: 1.25rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow:
        0 18px 30px rgba(15, 23, 42, 0.7),
        0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.8rem;
      font-size: 1.1rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem 1.25rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: #9ca3af;
    }

    select,
    input[type="number"] {
      width: 100%;
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.9);
      padding: 0.45rem 0.6rem;
      color: #e5e7eb;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      background: rgba(15, 23, 42, 1);
    }

    .muted {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.2rem;
    }

    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .kpi {
      flex: 1 1 130px;
      min-width: 130px;
      padding: 0.6rem 0.75rem;
      border-radius: 0.7rem;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .kpi-label {
      font-size: 0.75rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .kpi-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .kpi-highlight {
      font-size: 1.2rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      margin-top: 0.25rem;
      border: 1px solid transparent;
    }

    .status-neutral {
      background: rgba(75, 85, 99, 0.25);
      border-color: rgba(75, 85, 99, 0.5);
      color: #e5e7eb;
    }

    .status-excellent {
      background: rgba(22, 163, 74, 0.25);
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
    }

    .status-good {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.7);
      color: #bfdbfe;
    }

    .status-warn {
      background: rgba(234, 179, 8, 0.2);
      border-color: rgba(234, 179, 8, 0.7);
      color: #facc15;
    }

    .status-high {
      background: rgba(248, 113, 113, 0.16);
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .status-critical {
      background: rgba(127, 29, 29, 0.7);
      border-color: rgba(220, 38, 38, 0.85);
      color: #fecaca;
    }

    .daily-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .daily-header small {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .totals-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 0.8rem;
      overflow: hidden;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 0.85rem;
    }

    .totals-table thead {
      background: radial-gradient(circle at top left, #0f172a, #020617);
    }

    .totals-table th,
    .totals-table td {
      padding: 0.45rem 0.55rem;
      text-align: right;
    }

    .totals-table th:first-child,
    .totals-table td:first-child {
      text-align: left;
    }

    .totals-table tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.95);
    }

    .totals-table tbody tr:nth-child(even) {
      background: rgba(17, 24, 39, 0.95);
    }

    .totals-table tbody tr:hover {
      background: rgba(30, 64, 175, 0.45);
    }

    .pill {
      display: inline-flex;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.75rem;
    }

    .pill-good {
      border-color: rgba(34, 197, 94, 0.8);
      color: #bbf7d0;
    }

    .pill-bad {
      border-color: rgba(239, 68, 68, 0.9);
      color: #fecaca;
    }

    .pill-na {
      border-color: rgba(75, 85, 99, 0.9);
      color: #9ca3af;
    }

    .info-line {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }

    @media (max-width: 640px) {
      body {
        padding: 0.9rem;
      }

      .card {
        padding: 0.9rem 1rem 1.1rem;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      header img {
        height: 48px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <img src="logo.png" alt="AMG Logo" />
      <div>
        <h1>Labor % Calculator</h1>
        <p>Calculate labor percentage by park location</p>
      </div>
    </header>

    <section class="card" id="calculator">
      <h2>Calculator</h2>
      <div class="grid">
        <div>
          <label for="parkSelect">Select Park Location</label>
          <select id="parkSelect">
            <option value="" disabled selected>-- Choose a Park --</option>
          </select>
          <div class="muted">Pulled from <code>rates.json</code></div>
        </div>

        <div>
          <label>Hourly Rate</label>
          <div class="kpi">
            <span class="kpi-label">Hourly Rate</span>
            <span id="hourlyRate" class="kpi-value">$0.00</span>
          </div>
        </div>

        <div>
          <label for="laborHours">Labor Hours Total</label>
          <input
            id="laborHours"
            type="number"
            inputmode="decimal"
            step="0.01"
            min="0"
            placeholder="e.g. 145.5"
          />
        </div>

        <div>
          <label for="revenue">Revenue ($)</label>
          <input
            id="revenue"
            type="number"
            inputmode="decimal"
            step="0.01"
            min="0"
            placeholder="e.g. 25000"
          />
        </div>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <span class="kpi-label">Labor Percentage</span>
          <span id="laborPercentage" class="kpi-value kpi-highlight">--%</span>
          <span id="laborStatus" class="status-pill status-neutral">Waiting for inputs…</span>
        </div>
        <div class="kpi">
          <span class="kpi-label">Target</span>
          <span class="kpi-value">
            ≤ <span id="targetDisplay">18</span>%
          </span>
          <div class="muted">Configurable via <code>rates.json</code> (<code>target_percentage</code>)</div>
        </div>
        <div class="kpi">
          <span class="kpi-label">Calculated Labor Cost</span>
          <span id="laborCost" class="kpi-value">$0.00</span>
        </div>
      </div>
    </section>

    <section class="card" id="dailyTotals">
      <div class="daily-header">
        <h2>Daily Totals</h2>
        <small id="dailyTotalsMeta"></small>
      </div>
      <p class="muted" id="dailyTotalsMessage">
        Choose a park above to see recent daily totals pulled from <code>daily_totals.json</code>.
      </p>
      <div id="dailyTotalsContent"></div>
      <p class="info-line">
        This calculator reads <code>rates.json</code> and <code>daily_totals.json</code> from GitHub Pages with a local
        fallback for development.
      </p>
    </section>
  </main>

  <script>
    // --------- CONFIG + FALLBACKS ---------

    const FALLBACK_RATES = {
      "Appleton": 17.32,
      "Austell": 16.07,
      "Gastonia": 16.99,
      "Huntsville": 14.86,
      "Lawrenceville": 13.55,
      "Lombard": 18.87,
      "Nashville": 17.10,
      "Pueblo": 18.27,
      "San Jose": 21.34,
      "York": 18.22
    };

    const DEFAULT_TARGET_PERCENTAGE = 18;

    let hourlyRates = { ...FALLBACK_RATES };
    let targetPercentage = DEFAULT_TARGET_PERCENTAGE;
    let dailyTotals = null;
    let selectedPark = "";

    // --------- INIT ---------

    document.addEventListener("DOMContentLoaded", () => {
      wireInputs();
      initApp();
    });

    function wireInputs() {
      const hours = document.getElementById("laborHours");
      const revenue = document.getElementById("revenue");

      hours.addEventListener("input", updateCalculations);
      revenue.addEventListener("input", updateCalculations);
    }

    async function initApp() {
      await loadRates();
      await loadDailyTotals();
      populateParkSelect();
      updateTargetDisplay();
      updateCalculations();
      updateDailyTotalsSection();
    }

    // --------- DATA LOADING ---------

    async function loadRates() {
      try {
        const res = await fetch("rates.json", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const parsed = parseRatesData(data);
        hourlyRates = parsed.hourlyRates;
        targetPercentage = parsed.targetPercentage;
        console.log("Loaded rates from rates.json", parsed);
      } catch (err) {
        console.warn("Using fallback rates because rates.json could not be read:", err);
        hourlyRates = { ...FALLBACK_RATES };
        targetPercentage = DEFAULT_TARGET_PERCENTAGE;
      }
    }

    function parseRatesData(data) {
      const result = {
        hourlyRates: {},
        targetPercentage: DEFAULT_TARGET_PERCENTAGE
      };

      if (!data || typeof data !== "object") {
        return { hourlyRates: { ...FALLBACK_RATES }, targetPercentage: DEFAULT_TARGET_PERCENTAGE };
      }

      // Target percentage (several possible property names)
      if (typeof data.target_percentage === "number") {
        result.targetPercentage = data.target_percentage;
      } else if (typeof data.targetPercent === "number") {
        result.targetPercentage = data.targetPercent;
      } else if (typeof data.target === "number") {
        result.targetPercentage = data.target;
      }

      // Where are the parks?
      // Prefer a nested "parks" object if present; otherwise use top-level.
      let source = data.parks && typeof data.parks === "object" ? data.parks : data;

      for (const [key, value] of Object.entries(source)) {
        const lowerKey = key.toLowerCase();

        // Ignore config-like keys
        if (lowerKey.includes("target") || lowerKey.includes("percent")) continue;
        if (value == null) continue;

        if (typeof value === "number") {
          result.hourlyRates[key] = value;
        } else if (typeof value === "object") {
          if (typeof value.hourly_rate === "number") {
            result.hourlyRates[key] = value.hourly_rate;
          } else if (typeof value.rate === "number") {
            result.hourlyRates[key] = value.rate;
          } else if (typeof value.wage === "number") {
            result.hourlyRates[key] = value.wage;
          }
        }
      }

      if (Object.keys(result.hourlyRates).length === 0) {
        // Fall back if nothing parseable
        result.hourlyRates = { ...FALLBACK_RATES };
      }

      return result;
    }

    async function loadDailyTotals() {
      try {
        const res = await fetch("daily_totals.json", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        dailyTotals = await res.json();

        const meta = document.getElementById("dailyTotalsMeta");
        if (meta) {
          const now = new Date();
          meta.textContent = "Loaded daily_totals.json • " + now.toLocaleString();
        }
      } catch (err) {
        console.warn("daily_totals.json not found or invalid, daily section will be empty:", err);
        dailyTotals = null;
        const meta = document.getElementById("dailyTotalsMeta");
        if (meta) meta.textContent = "No daily_totals.json found";
      }
    }

    // --------- UI UPDATES ---------

    function populateParkSelect() {
      const select = document.getElementById("parkSelect");
      if (!select) return;

      select.innerHTML = "";

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "-- Choose a Park --";
      placeholder.disabled = true;
      placeholder.selected = true;
      select.appendChild(placeholder);

      Object.keys(hourlyRates)
        .sort((a, b) => a.localeCompare(b))
        .forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

      select.addEventListener("change", () => {
        selectedPark = select.value;
        updateParkInfo();
      });
    }

    function updateParkInfo() {
      const rateSpan = document.getElementById("hourlyRate");

      if (!selectedPark || !hourlyRates[selectedPark]) {
        rateSpan.textContent = "$0.00";
      } else {
        rateSpan.textContent = formatCurrency(hourlyRates[selectedPark]);
      }

      updateCalculations();
      updateDailyTotalsSection();
    }

    function updateTargetDisplay() {
      const el = document.getElementById("targetDisplay");
      if (!el) return;
      const val = Number.isFinite(targetPercentage) ? targetPercentage : DEFAULT_TARGET_PERCENTAGE;
      // Avoid trailing ".0"
      el.textContent = val.toFixed(1).replace(/\.0$/, "");
    }

    function updateCalculations() {
      const hoursInput = document.getElementById("laborHours");
      const revenueInput = document.getElementById("revenue");

      const hours = parseFloat(hoursInput.value) || 0;
      const revenue = parseFloat(revenueInput.value) || 0;
      const rate = selectedPark && hourlyRates[selectedPark] ? hourlyRates[selectedPark] : 0;

      const laborCost = hours * rate;
      const laborCostEl = document.getElementById("laborCost");
      laborCostEl.textContent = formatCurrency(laborCost);

      let percent = 0;
      if (revenue > 0 && laborCost >= 0) {
        percent = (laborCost / revenue) * 100;
      }

      const percentEl = document.getElementById("laborPercentage");
      if (!revenue || !hours || !selectedPark) {
        percentEl.textContent = "--%";
      } else {
        percentEl.textContent = percent.toFixed(1) + "%";
      }

      const statusEl = document.getElementById("laborStatus");
      statusEl.className = "status-pill"; // reset

      if (!selectedPark || !hours || !revenue) {
        statusEl.textContent = "Waiting for inputs…";
        statusEl.classList.add("status-neutral");
        return;
      }

      if (percent <= 15) {
        statusEl.textContent = "Excellent (≤ 15%)";
        statusEl.classList.add("status-excellent");
      } else if (percent <= targetPercentage) {
        statusEl.textContent = "On Target (≤ " + targetPercentage + "%)";
        statusEl.classList.add("status-good");
      } else if (percent <= targetPercentage + 4) {
        statusEl.textContent = "Slightly Above Target";
        statusEl.classList.add("status-warn");
      } else if (percent <= targetPercentage + 10) {
        statusEl.textContent = "High — Needs Attention";
        statusEl.classList.add("status-high");
      } else {
        statusEl.textContent = "Critical — Way Over";
        statusEl.classList.add("status-critical");
      }
    }

    function updateDailyTotalsSection() {
      const msg = document.getElementById("dailyTotalsMessage");
      const container = document.getElementById("dailyTotalsContent");
      if (!msg || !container) return;

      container.innerHTML = "";

      if (!selectedPark) {
        msg.textContent = "Choose a park above to see recent daily totals pulled from daily_totals.json.";
        return;
      }

      if (!dailyTotals) {
        msg.textContent = "No daily_totals.json loaded. Daily section is informational only.";
        return;
      }

      const rows = getDailyRowsForPark(selectedPark);

      if (!rows.length) {
        msg.textContent =
          "No daily totals found for “" +
          selectedPark +
          "”. Check that daily_totals.json includes this park.";
        return;
      }

      msg.textContent = "";

      const table = document.createElement("table");
      table.className = "totals-table";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Date</th>
          <th>Labor Hours</th>
          <th>Revenue</th>
          <th>Labor %</th>
          <th>vs


